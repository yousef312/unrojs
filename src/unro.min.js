const algos=["clearpath","insertion","lineare"],dfn=()=>{};let counter=0;const clamp=(t,n,e)=>t<n?n:t>e?e:t;Array.prototype.insert=function(t,n){var e,r,i;return this.splice((e=n,r=0,i=this.length,e<r?r:e>i?i:e),0,t),n};export class Unro{#t=[];#n=null;#e=!1;#r=!1;#i=[];#s=null;constructor(){this.current=-1,this.maximum=100,this.algo="clearpath";this.#s=(()=>{let t,n,e,r,i,s;return{use:n=>{if(!(n instanceof OffscreenCanvasRenderingContext2D||n instanceof CanvasRenderingContext2D))throw new Error('UnroJs Definition Error\n Parameter passed in ".use" function must be of type OffscreenCanvasRenderingContext2D or CanvasRenderingContext2D');t=n},label:t=>n=t,register:(n,i)=>{if(!(t||i&&(i instanceof OffscreenCanvasRenderingContext2D||i instanceof CanvasRenderingContext2D)))throw new Error('UnroJs Defintion Error\n ".register" is missing the source parameter');const s=i||t;switch(n){case"undo":e=s instanceof ImageData?s:s.getImageData(0,0,s.canvas.width,s.canvas.height);break;case"redo":r=s instanceof ImageData?s:s.getImageData(0,0,s.canvas.width,s.canvas.height)}},after:(t,n)=>{"undo"===t&&"function"==typeof n?i=n:"redo"===t&&"function"==typeof n?s=n:"function"==typeof t&&(i=s=t)},process:function(){if(!(this instanceof Unro))throw new Error('UnroJs Error\n".process" function is only callable from within Unro class');if(!e||!r||!t)throw new Error('UnroJs Definition Error\n Definition is missing "undo" or "redo" stacks or destination CanvasContext! make sure to call ".register(stack)" and ".use(dst)" from within the maker');let o=new Stack({undo:function(){this.load("source").putImageData(this.load("undo"),0,0),this.load("undo-cb")&&this.load("undo-cb")()},redo:function(){this.load("source").putImageData(this.load("redo"),0,0),this.load("redo-cb")&&this.load("redo-cb")()},label:n});return o.save("source",t),o.save("undo",e),o.save("redo",r),"function"==typeof i&&o.save("undo-cb",i),"function"==typeof s&&o.save("redo-cb",s),o},kill:function(){if(!(this instanceof Unro))throw new Error('UnroJs Error\n".kill" function is only callable from within Unro class');r=e=n=t=void 0}}})()}get lastAction(){return this.#n}get isFirstStack(){return!0===this.#r}get isLastStack(){return!0===this.#e}push(t,n){if(!t||"[object Object]"!==t.toString()&&!["string","function"].includes(typeof t))return;if("string"==typeof t){let e=this.#i.find((n=>n.label===t));if(!e)return;t={undo:function(){e.undo(n)},redo:function(){e.redo(n)}}}let e;if("function"==typeof t)t(this.#s),e=this.#s.process.call(this),this.#s.kill.call(this);else{if("function"!=typeof t.undo||"function"!=typeof t.redo)throw new Error("[UnroJS] wrong stack defintion in .push, a stack must have undo & redo or init functions");e=new Stack(t)}let r=this.current;return"lineare"===this.algo?this.current=this.#t.push(e)-1:"clearpath"===this.algo?(void 0!==this.#t[r+1]&&this.#t.splice(r+1,this.#t.length),this.current=this.#t.push(e)-1):"insertion"===this.algo&&(this.current=this.#t.insert(e,r+1)),this.#t.length>this.maximum&&(this.#t.shift(),this.current=r),this.#r=!1,this.current}undo(){if(!this.#r)return this.#n="undo",this.#t[this.current].undo(this),this.current>-2&&this.current--,this.current<0?this.#r=!0:(this.#e=!1,this)}redo(){return this.#t[this.current+1]?(this.current++,this.#t[this.current].redo(this),this.#n="redo",this.#r=!1,this):this.#e=!0}expand(t){return this.maximum="number"==typeof t?t:this.maximum,this}free(){return this.#t=[],this.current=0,this}moveTo(t){if(t===this.current)return"current";if(this.#t[t]){if(t>this.current)for(let n=this.current+1;n<=t;n++)this.current=n,this.#t[n].redo(this);else for(let n=this.current;n>=t;n--)this.current=n,this.#t[n].undo(this);return this.current=t,this.#t[t]}return"out-of-range"}setAlgorithme(t){return!!algos.includes(t)&&(this.algo=t,!0)}exportStackActions(){let t=[];return this.#t.forEach((n=>t.push({action:n.label,date:n.date}))),JSON.stringify({stacks:t})}acquire(t,n){if(t.bind){let e=this,r="ctrl+w",i="ctrl+y";"b"==n&&(r="ctrl+w",i="ctrl+shift+y"),t.bind(r,(function(){e.undo()})),t.bind(i,(function(){e.redo()}))}return this}defineHandler(t){if("[object Object]"!==t.toString()||"string"!=typeof t.label||"function"!=typeof t.undo||"function"!=typeof t.redo)throw new Error('UnroJs Error\n trying to use ".defineHandler" function with wrong parameter type or structure!');this.#i.push(t)}removeHandler(t){if("string"==typeof t){let n=this.#i.findIndex((n=>n.label===t));if(-1!=n)return this.#i.splice(n,1),!0}return!1}hasHandler(t){return-1!=this.#i.findIndex((n=>n.label===t))}get len(){return this.#t.length}}class Stack{#o=dfn;#a=dfn;#c={};#u=++counter;constructor(t){this.#o=t.undo,this.#a=t.redo,this.date=new Date,this.label=t.label}get undo(){return this.#o}get redo(){return this.#a}get id(){return this.#u}save(t,n){"string"==typeof t&&null!=n&&(this.#c[t]=n)}load(t){return t?this.#c[t]:{...this.#c}}}function unro(){return new Unro}window.unro=unro;export default unro;